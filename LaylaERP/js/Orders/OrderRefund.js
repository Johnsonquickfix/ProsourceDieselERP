var wc_users_params = [{ "name": "United States", "abbreviation": "US", "states": [{ "name": "Alabama", "abbreviation": "AL" }, { "name": "Alaska", "abbreviation": "AK" }, { "name": "American Samoa", "abbreviation": "AS" }, { "name": "Arizona", "abbreviation": "AZ" }, { "name": "Arkansas", "abbreviation": "AR" }, { "name": "California", "abbreviation": "CA" }, { "name": "Colorado", "abbreviation": "CO" }, { "name": "Connecticut", "abbreviation": "CT" }, { "name": "Delaware", "abbreviation": "DE" }, { "name": "District Of Columbia", "abbreviation": "DC" }, { "name": "Federated States Of Micronesia", "abbreviation": "FM" }, { "name": "Florida", "abbreviation": "FL" }, { "name": "Georgia", "abbreviation": "GA" }, { "name": "Guam", "abbreviation": "GU" }, { "name": "Hawaii", "abbreviation": "HI" }, { "name": "Idaho", "abbreviation": "ID" }, { "name": "Illinois", "abbreviation": "IL" }, { "name": "Indiana", "abbreviation": "IN" }, { "name": "Iowa", "abbreviation": "IA" }, { "name": "Kansas", "abbreviation": "KS" }, { "name": "Kentucky", "abbreviation": "KY" }, { "name": "Louisiana", "abbreviation": "LA" }, { "name": "Maine", "abbreviation": "ME" }, { "name": "Marshall Islands", "abbreviation": "MH" }, { "name": "Maryland", "abbreviation": "MD" }, { "name": "Massachusetts", "abbreviation": "MA" }, { "name": "Michigan", "abbreviation": "MI" }, { "name": "Minnesota", "abbreviation": "MN" }, { "name": "Mississippi", "abbreviation": "MS" }, { "name": "Missouri", "abbreviation": "MO" }, { "name": "Montana", "abbreviation": "MT" }, { "name": "Nebraska", "abbreviation": "NE" }, { "name": "Nevada", "abbreviation": "NV" }, { "name": "New Hampshire", "abbreviation": "NH" }, { "name": "New Jersey", "abbreviation": "NJ" }, { "name": "New Mexico", "abbreviation": "NM" }, { "name": "New York", "abbreviation": "NY" }, { "name": "North Carolina", "abbreviation": "NC" }, { "name": "North Dakota", "abbreviation": "ND" }, { "name": "Northern Mariana Islands", "abbreviation": "MP" }, { "name": "Ohio", "abbreviation": "OH" }, { "name": "Oklahoma", "abbreviation": "OK" }, { "name": "Oregon", "abbreviation": "OR" }, { "name": "Palau", "abbreviation": "PW" }, { "name": "Pennsylvania", "abbreviation": "PA" }, { "name": "Puerto Rico", "abbreviation": "PR" }, { "name": "Rhode Island", "abbreviation": "RI" }, { "name": "South Carolina", "abbreviation": "SC" }, { "name": "South Dakota", "abbreviation": "SD" }, { "name": "Tennessee", "abbreviation": "TN" }, { "name": "Texas", "abbreviation": "TX" }, { "name": "Utah", "abbreviation": "UT" }, { "name": "Vermont", "abbreviation": "VT" }, { "name": "Virgin Islands", "abbreviation": "VI" }, { "name": "Virginia", "abbreviation": "VA" }, { "name": "Washington", "abbreviation": "WA" }, { "name": "West Virginia", "abbreviation": "WV" }, { "name": "Wisconsin", "abbreviation": "WI" }, { "name": "Wyoming", "abbreviation": "WY" }] }, { "name": "Canada", "abbreviation": "CA", "states": [{ "name": "Alberta", "abbreviation": "AB" }, { "name": "British Columbia", "abbreviation": "BC" }, { "name": "Manitoba", "abbreviation": "MB" }, { "name": "New Brunswick", "abbreviation": "NB" }, { "name": "Newfoundland and Labrador", "abbreviation": "NL" }, { "name": "Northwest Territories", "abbreviation": "NT" }, { "name": "Nova Scotia", "abbreviation": "NS" }, { "name": "Nunavut", "abbreviation": "NU" }, { "name": "Ontario", "abbreviation": "ON" }, { "name": "Prince Edward Island", "abbreviation": "PE" }, { "name": "Quebec", "abbreviation": "QC" }, { "name": "Saskatchewan", "abbreviation": "SK" }, { "name": "Yukon Territory", "abbreviation": "YT" }] }]
var auto_coupon = [{ post_title: "matt-found", title: "Mattress-Foundation", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '20861,118', exclude_product_ids: '' },
{ post_title: "matt-topper", title: "Mattress-Topper", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '56774,118', exclude_product_ids: '' },
{ post_title: "matt-bedframe", title: "Mattress-Bedframe", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '56774,118', exclude_product_ids: '' },
{ post_title: "matt-sheet", title: "Mattress-Sheet", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '124524,118', exclude_product_ids: '' },
{ post_title: "matt-blanket", title: "Mattress-Blanket", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '128244,118', exclude_product_ids: '' },
{ post_title: "matt-pillow", title: "Mattress-Pillow", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 10, product_ids: '14023,118', exclude_product_ids: '' },
{ post_title: "found-frame", title: "Bundle Discount", type: 'auto_coupon', discount_type: 'fixed_cart', coupon_amount: 25, product_ids: '31729,20861', exclude_product_ids: '' },
{ post_title: "kapok-pillow", title: "Kapok Pillow", type: 'diff', discount_type: '2x_percent', coupon_amount: 50, product_ids: '14023,14023', exclude_product_ids: '' },
{ post_title: '118', title: 'Memory Foam Mattress', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "118 ", exclude_product_ids: '' },
{ post_title: '611172', title: 'Hybrid Mattress', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611172 ", exclude_product_ids: '' },
{ post_title: '14023', title: 'Kapok Pillow', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "14023 ", exclude_product_ids: '' },
{ post_title: '611238', title: 'Memory Foam Pillow', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611238 ", exclude_product_ids: '' },
{ post_title: '20861', title: 'Mattress Foundation', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "20861 ", exclude_product_ids: '' },
{ post_title: '31729', title: 'Bed Frame', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "31729 ", exclude_product_ids: '' },
{ post_title: '611252', title: 'Platform Bed', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611252 ", exclude_product_ids: '' },
{ post_title: '611286', title: 'Adjustable Base', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611286 ", exclude_product_ids: '' },
{ post_title: '124524', title: 'Bamboo Sheets', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "124524 ", exclude_product_ids: '' },
{ post_title: '128244', title: 'Weighted Blanket', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "128244 ", exclude_product_ids: '' },
{ post_title: '56774', title: 'Memory Foam Topper', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "56774 ", exclude_product_ids: '' },
{ post_title: '611268', title: 'Essential Mattress Protector', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611268 ", exclude_product_ids: '' },
{ post_title: '612955', title: 'Full Encasement Mattress Protector', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "612955 ", exclude_product_ids: '' },
{ post_title: '612947', title: 'Cooling Mattress Protector', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "612947 ", exclude_product_ids: '' },
{ post_title: '611220', title: 'Pet Bed', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "611220 ", exclude_product_ids: '' },
{ post_title: '612995', title: 'Adjustable Base Plus', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "612995 ", exclude_product_ids: '' },
{ post_title: '733500', title: 'Metal Platform Base', type: 'diff', discount_type: 'fixed_product', coupon_amount: 0, product_ids: "733500 ", exclude_product_ids: '' }
];
var recycling_item = [118, 20861, 611172];

$(document).ready(function () {
    $('.billinfo').prop("disabled", true);
    setTimeout(function () { $("#loader").show(); getOrderInfo(); }, 20);
    $("#ddlshipcountry").change(function () { var obj = { id: $("#ddlshipcountry").val() }; BindStateCounty("ddlshipstate", obj); });
    $(document).on("click", ".btnRefundOrder", function (t) {
        t.preventDefault(); $('.billinfo').prop("disabled", false);
        $('.box-tools,.footer-finalbutton').empty().append('<button type="button" class="btn btn-danger btnRefundCancel">Cancel</button> <button type="button" class="btn btn-danger btnRefundOk">Refund $0.00 manually</button>');
    });
    $(document).on("click", ".btnRefundCancel", function (t) {
        t.preventDefault(); $('.billinfo').prop("disabled", true); getOrderInfo();
    });
});
///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Common ajax function ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
var ajaxFunc = function (url, data, beforeSendFun, successFun, completeFun, errorFun) {
    $.ajax({ type: "POST", url: url, contentType: "application/json; charset=utf-8", dataType: "json", data: JSON.stringify(data), beforeSend: beforeSendFun, success: successFun, complete: completeFun, error: errorFun, async: false, global: false });
}
function beforeSendFun() { $("#loader").css("display", ""); $("#loader").show(); }
function completeFun() { $("#loader").css("display", "none"); $("#loader").hide(); }
function errorFun(XMLHttpRequest, textStatus, errorThrown) { $("#loader").hide(); swal('Alert!', errorThrown, "error"); }
///Bind States of Country
function BindStateCounty(ctr, obj) {
    var res = wc_users_params.filter(element => element.abbreviation == obj.id);
    $("#" + ctr + "").html('<option value="0">Select</option>');
    if (res.length > 0) {
        for (i = 0; i < res[0].states.length; i++) { $("#" + ctr + "").append('<option value="' + res[0].states[i].abbreviation + '">' + res[0].states[i].name + '</option>'); }
    }
}

///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Edit Order ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function getOrderInfo() {
    let oid = parseInt($('#hfOrderNo').val()) || 0;
    if (oid > 0) {
        $('#ddlStatus').prop("disabled", true);
        $('#lblOrderNo').text('Order #' + oid + ' detail '); $('#hfOrderNo').val(oid);
        $('#order_line_items,#order_state_recycling_fee_line_items,#order_fee_line_items,#order_shipping_line_items,#order_refunds,#billCoupon,.refund-action').empty();
        $('#btnCheckout').remove(); $('.box-tools,.footer-finalbutton').empty().append('<button type="button" class="btn btn-danger btnRefundOrder"><i class="far fa-edit"></i> Refund</button>');
        var opt = { strValue1: oid };
        ajaxFunc('/Orders/GetOrderInfo', opt, beforeSendFun, function (result) {
            var data = JSON.parse(result);
            if (data.length > 0) {
                if (data[0].payment_method.trim().length > 0)
                    $('.payment-history').text('Payment via ' + data[0].payment_method + ' ' + data[0].created_via + '. Customer IP: ' + data[0].ip_address);
                else
                    $('.payment-history').text('Customer IP: ' + data[0].ip_address);
                $('#txtLogDate').val(data[0].date_created);
                $('#ddlStatus').val(data[0].status.trim()).trigger('change'); $('#ddlUser').prop("disabled", true);
                $("#ddlUser").empty().append('<option value="' + data[0].customer_id + '" selected>' + data[0].customer_name + '</option>');
                ///billing_Details
                var tPhone = data[0].b_phone;
                if (tPhone != null) { tPhone = '(' + tPhone.substring(0, 3) + ') ' + tPhone.substring(3, 6) + '-' + tPhone.substring(6, 10); }
                let billing_Details = '<strong>' + data[0].b_first_name + ' ' + data[0].b_last_name + '</strong><br>';
                billing_Details += (data[0].b_company.length > 0 ? data[0].b_company + '<br>' : '') + (data[0].b_address_1.length > 0 ? data[0].b_address_1 + '<br>' : '')
                    + (data[0].b_address_2.length > 0 ? data[0].b_address_2 + '<br>' : '') + (data[0].b_city.length > 0 ? data[0].b_city + ', ' : '') + (data[0].b_state.length > 0 ? data[0].b_state + ', ' : '')
                    + (data[0].b_country.length > 0 ? data[0].b_country + ' ' : '') + (data[0].b_postcode.length > 0 ? data[0].b_postcode : '');
                billing_Details += '<br><strong>Email address:</strong><br>' + data[0].b_email + '<br><strong>Phone:</strong><br>' + tPhone;
                $('.billing-address').empty().append(billing_Details);

                ///shipping_Details
                let shipping_Details = '<strong>' + data[0].s_first_name + ' ' + data[0].s_last_name + '</strong><br>';
                shipping_Details += (data[0].s_company.length > 0 ? data[0].s_company + '<br>' : '') + (data[0].s_address_1.length > 0 ? data[0].s_address_1 + '<br>' : '')
                    + (data[0].s_address_2.length > 0 ? data[0].s_address_2 + '<br>' : '') + (data[0].s_city.length > 0 ? data[0].s_city + ', ' : '') + (data[0].s_state.length > 0 ? data[0].s_state + ', ' : '')
                    + (data[0].s_country.length > 0 ? data[0].s_country + ' ' : '') + (data[0].s_postcode.length > 0 ? data[0].s_postcode : '');
                $('.shipping-address').empty().append(shipping_Details);
                $('#txtshipfirstname').val(data[0].s_first_name); $('#txtshiplastname').val(data[0].s_last_name); $('#txtshipaddress1').val(data[0].s_address_1); $('#txtshipaddress2').val(data[0].s_address_2);
                $('#txtshipcompany').val(data[0].s_company); $('#txtshipzipcode').val(data[0].s_postcode); $('#txtshipcity').val(data[0].s_city);
                $('#ddlshipcountry').val(data[0].s_country.trim()).trigger('change'); $('#ddlshipstate').val(data[0].s_state.trim()).trigger('change');
                //bind Product
                getOrderItemList(oid);
            }
        }, function () { $("#loader").hide(); $('.billinfo').prop("disabled", true); }, function (XMLHttpRequest, textStatus, errorThrown) { $("#loader").hide(); swal('Alert!', errorThrown, "error"); });
    }
    else {
        $("#loader").hide();
        $('.refund-action').append('<button type="button" id="btnAddFee" class="btn btn-danger billinfo" disabled>Add Fee</button> ');
        $('.page-heading').text('Add New Order'); $('#btnSearch').prop("disabled", false); searchOrderModal();
    }
}
function getOrderItemList(oid) {
    var option = { strValue1: oid };
    //let coupon_list = [];
    ajaxFunc('/Orders/GetOrderProductList', option, beforeSendFun, function (data) {
        let itemHtml = '', recyclingfeeHtml = '', feeHtml = '', shippingHtml = '', refundHtml = '', couponHtml = '';
        let zQty = 0.00, zGAmt = 0.00, zTDiscount = 0.00, zTotalTax = 0.00, zShippingAmt = 0.00, zStateRecyclingAmt = 0.00, zFeeAmt = 0.00, zRefundAmt = 0.00;
        for (var i = 0; i < data.length; i++) {
            let orderitemid = parseInt(data[i].order_item_id) || 0;
            if (data[i].product_type == 'line_item') {
                let PKey = data[i].product_id + '_' + data[i].variation_id;
                itemHtml += '<tr id="tritemId_' + PKey + '" data-id="' + PKey + '" class="' + (data[i].is_free ? 'free_item' : 'paid_item') + '" data-pid="' + data[i].product_id + '" data-vid="' + data[i].variation_id + '" data-pname="' + data[i].product_name + '" data-gid="' + data[i].group_id + '" data-freeitem="' + data[i].is_free + '" data-freeitems=\'' + data[i].free_itmes + '\' data-orderitemid="' + orderitemid + '" data-qty="' + data[i].quantity + '">';
                itemHtml += '<td class="text-center"><i class="far fa-images"></i></td>';
                itemHtml += '<td>' + data[i].product_name + '</td>';
                itemHtml += '<td class="text-right">' + data[i].reg_price.toFixed(2) + '</td>';
                itemHtml += '<td class="text-right">' + data[i].quantity + '</td>';
                if (data[i].is_free) {
                    itemHtml += '<td><input min="0" max="' + data[i].quantity + '" autocomplete="off" disabled class="form-control number rowCalulate" type="number" id="txt_RefundQty_' + PKey + '" value="0" name="txt_RefundQty" placeholder="Qty"></td>';
                }
                else {
                    itemHtml += '<td><input min="0" max="' + data[i].quantity + '" autocomplete="off" class="form-control billinfo number rowCalulate" type="number" id="txt_RefundQty_' + PKey + '" value="0" name="txt_RefundQty" placeholder="Qty"></td>';
                }
                itemHtml += '<td class="TotalAmount text-right" data-regprice="' + data[i].reg_price + '"data-salerate="' + data[i].sale_price + '" data-discount="' + data[i].discount.toFixed(2) + '" data-amount="' + data[i].total + '" data-taxamount="' + data[i].tax_amount + '" data-shippingamt="' + data[i].shipping_amount + '">' + data[i].total.toFixed(2) + '</td>';
                itemHtml += '<td class="text-right RowDiscount" data-disctype="' + data[i].discount_type + '" data-couponamt="0">' + data[i].discount.toFixed(2) + '</td>';
                itemHtml += '<td class="text-right RowTax">' + data[i].tax_amount.toFixed(2) + '</td>';
                itemHtml += '</tr>';
                zQty = zQty + (parseFloat(data[i].quantity) || 0.00);
                zGAmt = zGAmt + (parseFloat(data[i].total) || 0.00);
                zTotalTax = zTotalTax + (parseFloat(data[i].tax_amount) || 0.00);
            }
            else if (data[i].product_type == 'coupon') {
                let cou_amt = parseFloat(data[i].discount) || 0.00;
                let coupon_list = auto_coupon.filter(element => element.post_title == data[i].product_name);
                for (var j = 0; j < coupon_list.length; j++) {
                    couponHtml += '<li id="li_' + coupon_list[j].post_title + '" data-coupon= "' + coupon_list[j].post_title + '" data-couponamt= "' + coupon_list[j].coupon_amount + '" data-disctype= "' + coupon_list[j].discount_type + '" data-rqprdids= "' + coupon_list[j].product_ids + '" data-excludeids= "' + coupon_list[j].exclude_product_ids + '" data-type= "' + coupon_list[j].type + '" data-orderitemid="' + orderitemid + '">';
                    couponHtml += '<a href="javascript:void(0);">';
                    couponHtml += '<i class="fa fa-gift"></i>';
                    couponHtml += '<span>' + coupon_list[j].title + '</span>';
                    couponHtml += '<div class="pull-right">';
                    couponHtml += '$<span id="cou_discamt" style ="margin-right: 20px;">' + cou_amt.toFixed(2) + '</span>';
                    couponHtml += '</div>';
                    couponHtml += '</a>';
                    couponHtml += '</li>';
                }
                if (coupon_list.length == 0) {
                    let cpn_name = data[i].product_name;

                    couponHtml += '<li id="li_' + data[i].product_name + '" data-coupon= "' + data[i].product_name + '" data-couponamt= "' + data[i].discount.toFixed(2) + '" data-disctype= "" data-orderitemid="' + orderitemid + '">';
                    couponHtml += '<a href="javascript:void(0);">';
                    couponHtml += '<i class="fa fa-gift"></i>';
                    couponHtml += '<span>' + cpn_name + '</span>';
                    couponHtml += '<div class="pull-right">';
                    couponHtml += '$<span id="cou_discamt" style ="margin-right: 20px;">' + cou_amt.toFixed(2) + '</span>';
                    couponHtml += '</div>';
                    couponHtml += '</a>';
                    couponHtml += '</li>';
                }
                zTDiscount = zTDiscount + cou_amt;
            }
            else if (data[i].product_type == 'fee' && data[i].product_name == 'State Recycling Fee') {
                recyclingfeeHtml += '<tr id="trfeeid_' + orderitemid + '" data-orderitemid="' + orderitemid + '" data-pname="' + data[i].product_name + '">';
                recyclingfeeHtml += '<td class="text-center item-action"><i class="fa fa-plus-circle"></i></td>';
                recyclingfeeHtml += '<td>' + data[i].product_name + '</td><td></td><td></td><td class="RefundAmount text-right"></td><td class="TotalAmount text-right">' + data[i].total.toFixed(2) + '</td><td></td><td></td>';
                recyclingfeeHtml += '</tr>';
                zStateRecyclingAmt = zStateRecyclingAmt + (parseFloat(data[i].total) || 0.00);
                $("#stateRecyclingFeeTotal").data("orderitemid", orderitemid);
            }
            else if (data[i].product_type == 'fee' && data[i].product_name != 'State Recycling Fee') {
                let startingNumber = (data[i].product_name.match(/^-?\d+\.\d+|^-?\d+\b|^\d+(?=\w)/g) || []);
                let feetype = data[i].product_name.match(/%/g) != null ? '%' : '';
                let sd = feetype == '%' ? (parseFloat(startingNumber) || 0.00) : parseFloat(data[i].total);
                feeHtml += '<tr id="trfeeid_' + orderitemid + '" data-orderitemid="' + orderitemid + '" data-pname="' + data[i].product_name + '" data-feeamt="' + sd + '" data-feetype="' + feetype + '"> ';
                feeHtml += '<td class="text-center item-action"><i class="fas fa-plus-circle"></i></td>';
                feeHtml += '<td>' + data[i].product_name + '</td><td></td><td></td><td></td><td class="TotalAmount text-right">' + data[i].total.toFixed(2) + '</td><td></td><td></td>';
                feeHtml += '</tr>';
                zFeeAmt = zFeeAmt + (parseFloat(data[i].total) || 0.00);
            }
            else if (data[i].product_type == 'shipping') {
                shippingHtml += '<tr id="tritemId_' + orderitemid + '" data-orderitemid="' + orderitemid + '" data-pname="' + data[i].product_name + '">';
                shippingHtml += '<td class="text-center item-action"><i class="fa fa-shipping-fast"></i></td>';
                shippingHtml += '<td>Shipping</td><td></td><td></td><td class="RefundAmount text-right"></td><td class="TotalAmount text-right">' + data[i].total.toFixed(2) + '</td><td></td><td></td>';
                shippingHtml += '</tr>';
                zShippingAmt = zShippingAmt + (parseFloat(data[i].total) || 0.00);
                $("#shippingTotal").data("orderitemid", orderitemid);
            }
            else if (data[i].product_type == 'refund') {
                refundHtml += '<tr id="tritemId_' + orderitemid + '" data-orderitemid="' + orderitemid + '" data-pname="' + data[i].product_name + '">';
                refundHtml += '<td class="text-center item-action"><i class="fas fa-retweet"></i></td>';
                refundHtml += '<td>' + data[i].product_name + '</td><td></td><td></td><td></td><td class="TotalAmount text-right">' + data[i].total.toFixed(2) + '</td><td></td><td></td>';
                refundHtml += '</tr>';
                zRefundAmt = zRefundAmt + (parseFloat(data[i].total) || 0.00);
            }
            else if (data[i].product_type == 'tax') {
                $("#salesTaxTotal").data("orderitemid", orderitemid);
            }
        }
        $('#order_line_items').append(itemHtml); $('#order_state_recycling_fee_line_items').append(recyclingfeeHtml); $('#order_fee_line_items').append(feeHtml); $('#order_shipping_line_items').append(shippingHtml); $('#order_refunds').append(refundHtml);
        $('.refund-action').append('<button type="button" id="btnAddFee" class="btn btn-danger billinfo">Add Fee</button> ');
        //$('.refund-action').append('<button type="button" id="btnRefundItem" class="btn btn-danger billinfo">Refund</button>');
        $('#billCoupon').append(couponHtml);
        //Calculate Final
        $("#totalQty").text(zQty.toFixed(0)); $("#totalQty").data('qty', zQty.toFixed(0));
        $("#SubTotal").text(zGAmt.toFixed(2));
        $("#discountTotal").text(zTDiscount.toFixed(2));
        $("#salesTaxTotal").text(zTotalTax.toFixed(2));
        $("#shippingTotal").text(zShippingAmt.toFixed(2));
        $("#stateRecyclingFeeTotal").text(zStateRecyclingAmt.toFixed(2));
        $("#feeTotal").text(zFeeAmt.toFixed(2));
        $("#orderTotal").html((zGAmt - zTDiscount + zShippingAmt + zTotalTax + zStateRecyclingAmt + zFeeAmt).toFixed(2));
        $("#refundedTotal").text(zRefundAmt.toFixed(2));
        $("#netPaymentTotal").text(((zGAmt - zTDiscount + zShippingAmt + zTotalTax + zStateRecyclingAmt + zFeeAmt) + zRefundAmt).toFixed(2));
        //if (zRefundAmt != 0) $(".refund-total").removeClass('hidden'); else $(".refund-total").addClass('hidden');
        $("#order_line_items").find(".rowCalulate").change(function () { calculateRefunAmount(); });
    }, completeFun, errorFun);

    setTimeout(function () { getShippingCharge(); }, 50);
}

///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Shipping Charges ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function getShippingCharge() {
    let v_ids = []; let sh_state = $("#ddlshipstate").val() == 'CA' ? "CAA" : $("#ddlshipstate").val();
    $("#order_line_items  > tr.paid_item").each(function () { v_ids.push($(this).data('vid')); });
    let shipping_state = $("#ddlshipcountry").val() == 'US' ? sh_state : $("#ddlshipcountry").val();
    let options = { strValue1: v_ids.join(','), strValue2: shipping_state };
    $(".TotalAmount").data("shippingamt", 0.00);
    let zShippingAmt = 0.00;
    ajaxFunc('/Orders/GetProductShipping', options, beforeSendFun, function (data) {
        $("#order_line_items > tr.paid_item").each(function (index, tr) {
            let proudct_item = data.find(el => el.product_id === $(tr).data('vid'));
            if (proudct_item != null) {
                $('#tritemId_' + $(tr).data('id')).find(".TotalAmount").data("shippingamt", proudct_item.AK);
                zShippingAmt += proudct_item.AK;
            }
        });
    }, completeFun, errorFun);
    $('#order_shipping_line_items').find(".RefundAmount").text(zShippingAmt.toFixed(2));
}
function getStateRecyclingCharge() {
    let ship_state = $("#ddlshipstate").val();
    let zStateRecyclingAmt = 0.00, matCount = 0;
    $("#order_line_items > tr.paid_item").each(function () {
        if (recycling_item.includes($(this).data('pid'))) { matCount = matCount + (parseInt($(this).find("[name=txt_RefundQty]").val()) || 0.00); }
    });
    if (ship_state == "CA") { zStateRecyclingAmt = matCount * 10.5; }
    else if (ship_state == "CT") { zStateRecyclingAmt = matCount * 11.75; }
    else if (ship_state == "RI") { zStateRecyclingAmt = matCount * 16; }
    console.log(matCount, zStateRecyclingAmt);
    $('#order_state_recycling_fee_line_items').find(".RefundAmount").text(zStateRecyclingAmt.toFixed(2));
}
///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Current Refund Calculate ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function freeQtyUpdate() {
    $("#order_line_items > tr.free_item").each(function (index, row) {
        let zQty = 0.00, pid = parseInt($(this).data("pid")) || 0;
        $("#order_line_items  > tr.paid_item").each(function (pindex, prow) {
            if ($(prow).data('freeitems')[pid] != undefined) {
                zQty += parseFloat($(prow).find("[name=txt_RefundQty]").val()) * parseFloat($(prow).data('freeitems')[pid]);
            }
        });
        $(row).find("[name=txt_RefundQty]").val(zQty.toFixed(0));
    });
}
function calculateRefunAmount() {
    freeQtyUpdate();
    getStateRecyclingCharge();
}
///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Coupon and Product Modal ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function calculateDiscountAcount() {
    var tax_rate = parseFloat($('#hfTaxRate').val()) || 0.00; var zCartDisAmt = 0.00;
    //Without Coupon calculate
    $("#order_line_items  > tr").each(function () {
        let zQty = 0.00, zRegPrice = 0.00, zGrossAmount = 0.00;
        zQty = parseFloat($(this).find("[name=txt_ItemQty]").val()) || 0.00;
        zRegPrice = parseFloat($(this).find(".TotalAmount").data("regprice")) || 0.00;
        zGrossAmount = zRegPrice * zQty;
        $(this).find(".TotalAmount").data("amount", zGrossAmount.toFixed(2)); $(this).find(".TotalAmount").text(zGrossAmount.toFixed(2));

        //free item Qty
        var zFreeQty = 0.00, gid = parseInt($(this).data("gid")) || 0;
        $("#order_line_items  > tr").each(function () {
            if ($(this).data('gid') == gid && $(this).data('pid') != gid) {
                zFreeQty += parseFloat($(this).find("[name=txt_ItemQty]").val()) || 0.00;
            }
        });
        $('#txt_ItemQty_' + $(this).data("gid") + '_0').val(zFreeQty * 2);

        $(this).find(".RowDiscount").data("disctype", 'fixed');
        $(this).find(".RowDiscount").data("couponamt", 0.00);
        $(this).find(".RowDiscount").text(0.00); $(this).find(".TotalAmount").data("discount", 0.00);
        //Taxation                     
        zTotalTax = (((zGrossAmount - 0.00) * tax_rate) / 100);
        $(this).find(".RowTax").text(zTotalTax.toFixed(2)); $(this).find(".TotalAmount").data("taxamount", zTotalTax.toFixed(2));

    });

    $('#billCoupon li').each(function (index) {
        let cou_amt = 0.00;
        let zCouponAmt = parseFloat($(this).data('couponamt')) || 0.00, zDiscType = $(this).data('disctype'), zType = $(this).data('type'), zQty = 0.00, zRegPrice = 0.00, zSalePrice = 0.00, zGrossAmount = 0.00, zDisAmt = 0.00;

        let rq_prd_ids = [], exclude_ids = [];
        ////DiscType not equal 'fixed_cart' Fixed Add in Cart Discount
        if (zDiscType == 'fixed_cart') {
            //Coupon Amount Total
            cou_amt = zCouponAmt;
            zCartDisAmt = zCartDisAmt + zCouponAmt;
        }
        else if (zDiscType != 'fixed_cart') {
            if ($(this).data('excludeids') != "" && $(this).data('excludeids') != null) {
                exclude_ids = $(this).data('excludeids').split(",").map((el) => parseInt(el));
            }
            if ($(this).data('rqprdids') != "" && $(this).data('rqprdids') != null) {
                rq_prd_ids = $(this).data('rqprdids').split(",").map((el) => parseInt(el));
            }

            var discounted_prc = parseFloat($('#totalQty').data('qty')) || 0.00;
            if (zDiscType == 'fixed_cart') { zCouponAmt = (zCouponAmt / discounted_prc); }
            $("#order_line_items  > tr").each(function () {
                //Discout Not Apply in free items
                if (!$(this).data('freeitem')) {
                    var pid = $(this).data('pid'), vid = $(this).data('vid');
                    if (!exclude_ids.includes(pid) && !exclude_ids.includes(vid) && ((rq_prd_ids.includes(pid) || rq_prd_ids.includes(vid)) || rq_prd_ids == 0)) {
                        zQty = parseFloat($(this).find("[name=txt_ItemQty]").val()) || 0.00;
                        zRegPrice = parseFloat($(this).find(".TotalAmount").data("regprice")) || 0.00;
                        zSalePrice = parseFloat($(this).find(".TotalAmount").data("salerate")) || 0.00;
                        zGrossAmount = zRegPrice * zQty;
                        $(this).find(".TotalAmount").data("amount", zGrossAmount.toFixed(2)); $(this).find(".TotalAmount").text(zGrossAmount.toFixed(2));

                        //free item Qty
                        //var zFreeQty = 0.00, gid = parseInt($(this).data("gid")) || 0;
                        //$("#order_line_items  > tr").each(function () {
                        //    if ($(this).data('gid') == gid && $(this).data('pid') != gid) {
                        //        zFreeQty += parseFloat($(this).find("[name=txt_ItemQty]").val()) || 0.00;
                        //    }
                        //});
                        //$('#txt_ItemQty_' + $(this).data("gid") + '_0').val(zFreeQty * 2);

                        ////Coupun Type 'diff' and DiscType not equal '2x_percent' (CouponAmt = RegPrice - SalePrice)
                        if (zType == 'diff') {
                            if (zDiscType != '2x_percent') zCouponAmt = (zRegPrice - zSalePrice) > 0 ? (zRegPrice - zSalePrice) : 0.00;
                        } else { zCouponAmt = 0.00; }

                        if (zDiscType == 'fixed_product') { zDisAmt = zCouponAmt * zQty; }
                        else if (zDiscType == 'fixed_cart') { zDisAmt = zCouponAmt * zQty; }
                        else if (zDiscType == 'percent') { zDisAmt = (zGrossAmount * zCouponAmt) / 100; }
                        else if (zDiscType == '2x_percent') { zDisAmt = ((zRegPrice * zCouponAmt) / 100) * Math.floor(zQty / 2); }

                        //Coupon Amount Total
                        cou_amt += zDisAmt;

                        $(this).find(".RowDiscount").data("disctype", 'fixed');
                        $(this).find(".RowDiscount").data("couponamt", zCouponAmt);
                        $(this).find(".RowDiscount").text(zDisAmt.toFixed(2)); $(this).find(".TotalAmount").data("discount", zDisAmt.toFixed(2));
                        //Taxation                     
                        zTotalTax = (((zGrossAmount - zDisAmt) * tax_rate) / 100);
                        $(this).find(".RowTax").text(zTotalTax.toFixed(2)); $(this).find(".TotalAmount").data("taxamount", zTotalTax.toFixed(2));
                    }
                }
            });
        }

        //update Coupon Amount
        $(this).find("#cou_discamt").text(cou_amt.toFixed(2))
        if (zDiscType == '2x_percent' && cou_amt > 0)
            $(this).removeClass('hidden');
        else if (zDiscType == '2x_percent')
            $(this).addClass('hidden');
    });
    $("#discountTotal").data('otherdisc', zCartDisAmt.toFixed(2));
    calcFinalTotals();
}